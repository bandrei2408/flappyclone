<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="js/jquery-2.0.3.min.js" type="text/javascript"></script>
        <script src="js/phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">

    window.onload = function() {

        var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', { preload: preload, create: create, update: update });
        var bg;
        var platforms;
        var obstacles;
        var spawnColliders;
        var player;
        var cursors;
        var camera;
        var pointX;
        var ground;
        var score;
        var lastX;

        function preload () {

            game.load.image('background', 'assets/bg.png');
            game.load.image('ground','assets/ground.png');
            game.load.image('obstacle_top','assets/ob_large_top.png');
            game.load.image('obstacle_bot','assets/ob_large_bot.png');
            game.load.spritesheet('bat','assets/bat.png',52,54);
            game.load.spritesheet('blood_a','assets/blood_a_sprite.png',100,100);
            game.load.image('collideBox','assets/collide_box.png');

        }

        function create () {
            score = 0;
            game.stage.backgroundColor = '#000000';
            //bg = game.add.tileSprite(-90000, -128, 90800, 600, 'background');
            bg = game.add.tileSprite(0,0,800,600,'background');
            bg.fixedToCamera = true;
            obstacles = game.add.group();
            platforms = game.add.group();
            spawnColliders = game.add.group();
            pointX = -235
            
            for (i = 0 ; i <= 3 ; i++){
                distRand = Math.floor(Math.random()*214+1);
                pointY1 = game.world.height - 50 - distRand - 128;
                pointY2 = - distRand ;
                var obstacle = obstacles.create(pointX*i,pointY1,'obstacle_bot');
                var obstacle2 = obstacles.create(pointX*i, pointY2 ,'obstacle_top');
                var collisionBox = spawnColliders.create(pointX*i - 50, pointY1 - 158 ,'collideBox');
                obstacle.body.immovable = true;
                obstacle2.body.immovable = true;
            }
            lastX = pointX * 3;

            var ground = platforms.create(800, game.world.height - 128, 'ground');
            ground.body.immovable = true;
            ground.scale.setTo(-10000, 4);

            player = game.add.sprite(750,280, 'bat');
            player.body.gravity.y = 800;
            player.body.bounce.y = 0.1;
            player.body.setRectangle(10,10,20,20);

            player.animations.add('move',[0,1,2,3,4,5,6,7],16,true)

            cursors = game.input.keyboard;
            game.world.setBounds(-90000,0,90800,600);
            game.camera.follow(player);
            score = 0; 

        }

        function update(){

            game.physics.collide(player, platforms, gameOverCollisionHandler, null, this);
            game.physics.collide(player, obstacles, gameOverCollisionHandler, null, this);
            game.physics.overlap(player, spawnColliders, spawnCollisionHandler, null, this);
            player.animations.play('move');
            player.body.velocity.x = -200;
            if (cursors.isDown(Phaser.Keyboard.SPACEBAR)){
                player.animations.stop();
                player.body.velocity.y = -300;
            }

            
        }

        function gameOverCollisionHandler(player,platform){
            var x,y;
            x = player.x;
            y = player.y;
            
            player.destroy();
            blood = game.add.sprite(x,y,'blood_a');
            blood.animations.add('boom',[0,1,2,3,4,5],10,true);
            blood.animations.play('boom',10,false,true);

        }

        function spawnCollisionHandler(player, collisionBox){
            
            /* Delete Collision Box */
            collisionBox.kill();
            
            /* Add score */
            score++;

            /* Delete obstacles */
            var obstaclesToDelete = new Array();
            var j = 0;
            for(i = 0 ; i < obstacles.length ; i++){
                var temp = obstacles.getAt(i); 
                if(temp.x >= player.x + 300){
                    obstaclesToDelete[j] = temp;
                    j++;
                }
            }
            for (j = 0; j < obstaclesToDelete.length; j++){
                obstacles.remove(obstaclesToDelete[j]);
            }

            /* Add obstacles */

            distRand = Math.floor(Math.random()*214+1);
            pointY1 = game.world.height - 50 - distRand - 128;
            pointY2 = - distRand ;
            lastX = lastX + pointX
            var obstacle = obstacles.create(lastX,pointY1,'obstacle_bot');
            var obstacle2 = obstacles.create(lastX, pointY2 ,'obstacle_top');
            var collisionBox = spawnColliders.create(lastX - 50, pointY1 - 158 ,'collideBox');
            obstacle.body.immovable = true;
            obstacle2.body.immovable = true;
        }
        
    };

    </script>

    </body>
</html>